<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ุงููุดุงูุฏุฉ</title>
</head>
<body>

<h2>ุงูุจุซ ุงููุจุงุดุฑ</h2>

<video id="video" autoplay playsinline muted
style="width:100%;max-width:400px;border:1px solid black"></video>

<br><br>

<button onclick="takeShot()">๐ธ ุตูุฑุฉ</button>
<button onclick="startRecord()">โบ ุชุณุฌูู</button>
<button onclick="stopRecord()">โน ุฅููุงู</button>
<button onclick="micOn()">๐ค ุชุดุบูู ุงูุตูุช</button>
<button onclick="micOff()">๐ ูุชู ุงูุตูุช</button>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer;
let remoteStream;
let recorder;
let chunks = [];

peer = new Peer("parent", {
  host: "peerjs.com",
  secure: true,
  port: 443
});

/* ุงูุฃุจ ูุณุชูุจู ุงูููุงููุงุช ูู ุงูุทูู */
peer.on("call", call => {
  // ูุง ูุฑุณู ุฃู ุดูุก ุนูุฏ ุงูุฅุฌุงุจุฉ
  call.answer(null);

  call.on("stream", stream => {
    remoteStream = stream;
    document.getElementById("video").srcObject = stream;
  });

  call.on("close", () => {
    console.log("ุชู ุฅุบูุงู ุงูุจุซ");
    remoteStream = null;
    document.getElementById("video").srcObject = null;
  });

  call.on("error", err => {
    console.log("ุฎุทุฃ ูู ุงูุจุซ:", err);
  });
});

/* ๐ธ ุตูุฑุฉ */
function takeShot() {
  const v = document.getElementById("video");
  if (!v.videoWidth) return alert("ุงูููุฏูู ุบูุฑ ุฌุงูุฒ");
  const c = document.createElement("canvas");
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.getContext("2d").drawImage(v, 0, 0);
  const a = document.createElement("a");
  a.href = c.toDataURL("image/png");
  a.download = "photo.png";
  a.click();
}

/* ๐ฅ ุชุณุฌูู */
function startRecord() {
  if (!remoteStream) return alert("ูุง ููุฌุฏ ุจุซ");
  recorder = new MediaRecorder(remoteStream, {mimeType: "video/webm;codecs=vp8,opus"});
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: "video/webm" });
    chunks = [];
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "record.webm";
    a.click();
  };
  recorder.start();
}

function stopRecord() {
  if (recorder) recorder.stop();
}

/* ๐ค ุงูุชุญูู ุจุงูุตูุช ุงููุงุฏู ูู ุงูุทูู */
function micOn() {
  if (!remoteStream) return;
  remoteStream.getAudioTracks().forEach(t => t.enabled = true);
}

function micOff() {
  if (!remoteStream) return;
  remoteStream.getAudioTracks().forEach(t => t.enabled = false);
}
</script>

</body>
</html>
