<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¨Ø« ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø·ÙÙ„</title>
</head>
<body>

<h2>Ø¨Ø« ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø·ÙÙ„</h2>

<video id="video" autoplay playsinline muted style="width:100%;max-width:400px;border:1px solid #000"></video>

<br><br>
<button onclick="takeShot()">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
<button onclick="startRecord()">âº ØªØ³Ø¬ÙŠÙ„</button>
<button onclick="stopRecord()">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
<button onclick="switchCam()">ğŸ” ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
<button onclick="micOn()">ğŸ¤ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
<button onclick="micOff()">ğŸ”‡ ÙƒØªÙ… Ø§Ù„Ù…Ø§ÙŠÙƒ</button>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer, remoteStream, recorder, chunks = [], dataConn;

// PeerJS
peer = new Peer("parent", {
  host: "peerjs.com",
  secure: true,
  port: 443
});

peer.on("open", () => {
  // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·ÙÙ„
  dataConn = peer.connect("child");

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
  function callChild(retries = 5, delay = 1000){
    if(retries <= 0){
      alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·ÙÙ„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
      return;
    }

    const call = peer.call("child", undefined);
    call.on("stream", stream => {
      remoteStream = stream;
      const videoEl = document.getElementById("video");
      videoEl.srcObject = stream;
      videoEl.play();
    });

    call.on("error", err => {
      console.warn("ÙØ´Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...", err);
      setTimeout(() => callChild(retries-1, delay), delay);
    });

    call.on("close", () => {
      console.log("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...");
      setTimeout(() => callChild(retries-1, delay), delay);
    });
  }

  callChild();
});

// Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±
function takeShot(){
  const v = document.getElementById("video");
  const c = document.createElement("canvas");
  c.width = v.videoWidth; c.height = v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);
  const a = document.createElement("a");
  a.href = c.toDataURL("image/png");
  a.download = "photo.png";
  a.click();
}

// Ø§Ù„ØªØ³Ø¬ÙŠÙ„
function startRecord(){
  recorder = new MediaRecorder(remoteStream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks,{type:"video/webm"});
    chunks = [];
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "video.webm";
    a.click();
  };
  recorder.start();
}

function stopRecord(){ recorder && recorder.stop(); }

// Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ
function switchCam(){ if(dataConn && dataConn.open) dataConn.send({cmd:"switchCamera"}); }
function micOn(){ if(dataConn && dataConn.open) dataConn.send({cmd:"mic", value:true}); }
function micOff(){ if(dataConn && dataConn.open) dataConn.send({cmd:"mic", value:false}); }

</script>
</body>
</html>
