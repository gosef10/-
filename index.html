<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>البث</title>
</head>
<body>

<h2>البث</h2>

<button id="start">تشغيل البث</button>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer;
let stream = null;

peer = new Peer("child", {
  host: "peerjs.com",
  secure: true,
  port: 443
});

/* استقبال الاتصال دائمًا */
peer.on("call", async call => {
  // انتظر تشغيل الكاميرا
  if (!stream) {
    alert("شغّل البث أولًا");
    return;
  }
  call.answer(stream);

  call.on("close", () => {
    console.log("تم إغلاق الاتصال");
  });
});

document.getElementById("start").onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });

    document.getElementById("start").style.display = "none";

  } catch {
    alert("لم يتم السماح بالكاميرا أو المايك");
  }
};

window.onbeforeunload = () => {
  if (stream) stream.getTracks().forEach(t => t.stop());
  peer.destroy();
};
</script>

</body>
</html>
